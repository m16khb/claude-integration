---
name: continue-task
description: "Execute advanced tasks with Opus using all available context"
argument-hint: <task_instruction>
allowed-tools:
  - Read
  - Write
  - Edit
  - Bash
  - Grep
  - Glob
  - WebSearch
  - WebFetch
  - Task
  - TodoWrite
  - AskUserQuestion
  - NotebookEdit
model: opus
---

# Opus 고급 작업 실행기 (v2)

inject-context 또는 new-session-continue-context와 연계하여 고급 작업을 수행하고, **완료 후 다음 단계 힌트를 제공**합니다.

**작업 지시**: $ARGUMENTS

---

## 핵심 개선사항 (v2)

| 항목 | v1 | v2 |
|------|-----|-----|
| 후속 작업 | 없음 | TUI 선택 메뉴로 다음 단계 제안 |
| 컨텍스트 파악 | 패턴 매칭 | 구조화된 컨텍스트 맵 생성 |
| 결과 보고 | 단순 마크다운 | 구조화된 보고서 + 액션 아이템 |

---

## 1단계: 컨텍스트 맵 구축

대화 히스토리를 스캔하여 **구조화된 컨텍스트 맵** 생성:

```
CONTEXT_MAP = {
    # inject-context로 로드된 파일들
    loaded_files: [
        {
            path: "파일 경로",
            lines: "N줄",
            chunks: "M개",
            type: "파일 타입",
            key_structures: ["클래스명", "함수명", ...]
        },
        ...
    ],

    # 세션 연속성 정보
    session_context: {
        previous_session: "요약 (있으면)",
        handoff_notes: "인수인계 노트 (있으면)"
    },

    # 직접 읽은 파일들
    read_files: ["path1", "path2", ...],

    # 사용자 요청 히스토리
    user_requests: ["요청1", "요청2", ...],

    # 현재 작업 컨텍스트
    current_task: "$ARGUMENTS"
}
```

### 컨텍스트 탐지 패턴

```
찾을 패턴 (대화 히스토리에서):
- "📁 파일 컨텍스트 주입 완료" → v2 inject-context
- "파일 컨텍스트 주입 완료" → v1 inject-context
- "이전 세션 컨텍스트 복원 완료" → 세션 연속성
- "===== 청크 N/M" → 청크 로드 경계
- Read 도구 결과 → 직접 읽은 파일
```

**중요**: 컨텍스트가 이미 있으면 다시 읽지 마세요. 히스토리를 최대한 활용하세요.

---

## 2단계: 작업 지시 해석

```
TASK = "$ARGUMENTS"

IF TASK가 비어있거나 "default":
    TASK = "파일 구조를 분석하고 핵심 로직을 설명하세요"
END IF

# 작업 유형 분류
TASK_TYPE = classify(TASK)
# 가능한 유형:
#   - analysis: 코드 분석, 구조 파악
#   - generation: 새 코드 생성
#   - refactoring: 코드 개선, 리팩토링
#   - debugging: 버그 수정, 문제 해결
#   - documentation: 문서화, 주석 추가
#   - testing: 테스트 작성, 검증
#   - security: 보안 검토
#   - optimization: 성능 최적화
```

---

## 3단계: 작업 수행

### 작업 유형별 전략

#### 분석 (Analysis)
```
1. 전체 구조 파악 (디렉토리, 모듈 구성)
2. 진입점 식별 (main, export, index)
3. 의존성 그래프 추적
4. 핵심 비즈니스 로직 식별
5. 패턴 및 안티패턴 탐지
6. 아키텍처 다이어그램 제안
```

#### 생성 (Generation)
```
1. 기존 코드 스타일 분석
2. 네이밍 컨벤션 파악
3. 유사 코드 참조
4. 새 코드 작성 (스타일 일관성 유지)
5. 테스트 코드 함께 생성
6. 문서화 주석 포함
```

#### 리팩토링 (Refactoring)
```
1. 현재 문제점 명확화
2. 목표 상태 정의
3. 영향 범위 분석
4. 점진적 변경 계획 수립
5. 각 단계별 검증 방법 제안
6. 롤백 전략 포함
```

#### 디버깅 (Debugging)
```
1. 증상 정확히 이해
2. 재현 조건 파악
3. 원인 가설 수립
4. 가설 검증 (로그, 테스트)
5. 최소 침습적 수정 제안
6. 회귀 테스트 제안
```

#### 문서화 (Documentation)
```
1. 대상 독자 파악
2. 기존 문서 스타일 분석
3. 예제 코드 포함
4. 엣지 케이스 설명
5. FAQ 섹션 추가
6. 변경 이력 반영
```

---

## 4단계: 결과 보고

```markdown
╔═══════════════════════════════════════════════════════════════╗
║                    📋 작업 완료 보고서                           ║
╠═══════════════════════════════════════════════════════════════╣
║ 작업: {TASK 요약}                                              ║
║ 유형: {TASK_TYPE}                                              ║
║ 상태: ✅ 완료 / ⚠️ 부분 완료 / ❌ 실패                          ║
╚═══════════════════════════════════════════════════════════════╝

### 📝 수행 내용

[구체적인 작업 내용 기술]

### 💻 코드 변경 (해당시)

```[language]
// 변경된 코드
```

### 📁 참조된 파일

| 파일 | 라인 | 설명 |
|------|------|------|
| `file1.ts` | 42-56 | 관련 함수 |
| `file2.py` | 100-120 | 호출 지점 |

### ⚡ 액션 아이템

- [ ] 항목1: 설명
- [ ] 항목2: 설명

### 💡 권장 사항

1. 첫 번째 권장 사항
2. 두 번째 권장 사항
```

---

## 5단계: 다음 단계 선택 (TUI-like) - 필수!

작업 완료 후 **AskUserQuestion 도구**로 후속 작업 선택:

```
AskUserQuestion(questions=[
    {
        "question": "작업이 완료되었습니다. 다음으로 무엇을 하시겠습니까?",
        "header": "후속 작업",
        "options": [
            {
                "label": "관련 파일 추가 분석",
                "description": "현재 분석과 관련된 다른 파일을 추가로 분석합니다"
            },
            {
                "label": "코드 변경 적용",
                "description": "제안된 변경사항을 실제 파일에 적용합니다"
            },
            {
                "label": "테스트 작성/실행",
                "description": "변경된 코드에 대한 테스트를 작성하거나 실행합니다"
            },
            {
                "label": "작업 완료",
                "description": "현재 작업을 완료하고 종료합니다"
            }
        ],
        "multiSelect": false
    }
])
```

### 선택에 따른 후속 처리

```
SWITCH user_selection:
    CASE "관련 파일 추가 분석":
        # 관련 파일 후보 제안
        suggestions = analyze_related_files(CONTEXT_MAP)
        AskUserQuestion으로 파일 선택받기
        → /inject-context {선택된 파일} 또는 직접 Read

    CASE "코드 변경 적용":
        # 제안된 변경사항을 Edit 도구로 적용
        apply_suggested_changes()
        # 적용 결과 보고

    CASE "테스트 작성/실행":
        # 테스트 유형 선택
        AskUserQuestion(questions=[
            {
                "question": "어떤 테스트 작업을 수행할까요?",
                "header": "테스트",
                "options": [
                    {"label": "단위 테스트 작성", "description": "새로운 단위 테스트를 작성합니다"},
                    {"label": "기존 테스트 실행", "description": "기존 테스트를 실행합니다"},
                    {"label": "테스트 커버리지 분석", "description": "테스트 커버리지를 분석합니다"}
                ],
                "multiSelect": false
            }
        ])

    CASE "작업 완료":
        # 최종 요약 출력
        print_final_summary()
        # 세션 컨텍스트 저장 제안 (필요시)
END SWITCH
```

---

## 작업 유형별 후속 옵션 커스터마이징

작업 유형에 따라 **다른 후속 옵션 세트** 제공:

### 분석(Analysis) 완료 후
```
옵션: [
    "심층 분석 (특정 모듈)",
    "아키텍처 다이어그램 생성",
    "개선점 구현",
    "작업 완료"
]
```

### 생성(Generation) 완료 후
```
옵션: [
    "코드 리뷰 요청",
    "테스트 추가",
    "문서화 추가",
    "작업 완료"
]
```

### 디버깅(Debugging) 완료 후
```
옵션: [
    "수정 적용",
    "회귀 테스트 작성",
    "관련 버그 탐색",
    "작업 완료"
]
```

---

## Opus 모델 활용 가이드

| 강점 | 활용 방법 |
|------|----------|
| 복잡한 추론 | 다단계 분석, 아키텍처 설계 |
| 코드 이해 | 패턴 인식, 버그 탐지 |
| 긴 컨텍스트 | 여러 파일 간 관계 파악 |
| 정확한 생성 | 프로덕션 품질 코드 |
| 신중한 판단 | 트레이드오프 분석 |

---

## 실행 (지금 수행)

1. **컨텍스트 맵 구축**: 대화 히스토리에서 로드된 파일/세션 정보 파악
2. **작업 해석**: "$ARGUMENTS"를 분석하여 작업 유형 분류
3. **작업 수행**: 유형에 맞는 전략으로 작업 철저히 수행
4. **결과 보고**: 구조화된 형식으로 결과 보고
5. **후속 작업 선택**: **AskUserQuestion으로 다음 단계 선택 받기** (필수!)
6. **선택 처리**: 사용자 선택에 따라 추가 작업 수행

---

## 주의사항

1. **컨텍스트 재사용**: 이미 로드된 파일은 다시 읽지 마세요
2. **명시적 참조**: 코드 인용 시 `파일명:라인` 형식 사용
3. **가정 명시**: 불확실한 부분은 가정을 밝히세요
4. **실행 가능성**: 제안하는 코드는 실제 실행 가능해야 합니다
5. **후속 작업 필수**: 작업 완료 후 반드시 AskUserQuestion 호출

---

## 중요: 절대 생략 금지

- **5단계 (후속 작업 선택)** - TUI 경험의 핵심
- 작업 완료 후 사용자에게 다음 단계 선택권 제공 필수
- 맥락에 맞는 후속 옵션 제안으로 워크플로우 연속성 유지
